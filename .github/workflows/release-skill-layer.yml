name: release-skill-layer

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to publish (for example, v0.4.0).
        required: false
        default: ''
        type: string
      consumer_repo:
        description: Source project repository to build against.
        required: false
        default: ''
        type: string
      consumer_ref:
        description: Source project ref to build against (branch/tag/ref).
        required: false
        default: ''
        type: string
      consumer_sha:
        description: Source project commit SHA that CI must validate.
        required: false
        default: ''
        type: string
      run_self_hosted:
        description: (Deprecated) retained for dispatch compatibility; no-op in CI-gated release flow.
        required: false
        default: true
        type: boolean
      run_build_spec:
        description: (Deprecated) retained for dispatch compatibility; no-op in CI-gated release flow.
        required: false
        default: true
        type: boolean
      labview_profile:
        description: LabVIEW target preset id from profiles/labview/profiles.json.
        required: false
        default: lv2026
        type: string
      source_labview_version_override:
        description: Optional effective source project .lvversion override (major.minor, minimum 20.0).
        required: false
        default: ''
        type: string
      run_lv2020_edge_smoke:
        description: Run optional non-gating LV2020 x64 edge smoke diagnostics during CI gate.
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  resolve-release-context:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      consumer_repo: ${{ steps.resolve.outputs.consumer_repo }}
      consumer_ref: ${{ steps.resolve.outputs.consumer_ref }}
      consumer_sha: ${{ steps.resolve.outputs.consumer_sha }}
      run_self_hosted: ${{ steps.resolve.outputs.run_self_hosted }}
      run_build_spec: ${{ steps.resolve.outputs.run_build_spec }}
      labview_profile: ${{ steps.resolve.outputs.labview_profile }}
      source_labview_version_override: ${{ steps.resolve.outputs.source_labview_version_override }}
      run_lv2020_edge_smoke: ${{ steps.resolve.outputs.run_lv2020_edge_smoke }}
      should_release: ${{ steps.resolve.outputs.should_release }}
      skip_reason: ${{ steps.resolve.outputs.skip_reason }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: resolve
        name: Resolve release context and auto-release decision
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_INPUTS_JSON: ${{ toJson(github.event.inputs) }}
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          VAR_SOURCE_PROJECT_REPO: ${{ vars.LVIE_SOURCE_PROJECT_REPO || '' }}
          VAR_SOURCE_PROJECT_REF: ${{ vars.LVIE_SOURCE_PROJECT_REF || '' }}
          VAR_SOURCE_PROJECT_SHA: ${{ vars.LVIE_SOURCE_PROJECT_SHA || '' }}
          VAR_LABVIEW_PROFILE: ${{ vars.LVIE_LABVIEW_PROFILE || '' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $manifestPath = Join-Path $env:GITHUB_WORKSPACE 'manifest.json'
          if (-not (Test-Path -LiteralPath $manifestPath -PathType Leaf)) {
            throw "manifest.json not found at '$manifestPath'."
          }
          $manifest = Get-Content -LiteralPath $manifestPath -Raw -ErrorAction Stop | ConvertFrom-Json -ErrorAction Stop
          $manifestVersion = [string]$manifest.version
          if ([string]::IsNullOrWhiteSpace($manifestVersion)) {
            throw "manifest.json is missing required 'version' value."
          }
          $defaultReleaseTag = "v$manifestVersion"

          $defaultConsumerRepo = [string]$env:VAR_SOURCE_PROJECT_REPO
          if ([string]::IsNullOrWhiteSpace($defaultConsumerRepo)) {
            $defaultConsumerRepo = '{0}/labview-icon-editor' -f [string]$env:GITHUB_REPOSITORY_OWNER
          }
          $defaultConsumerRef = [string]$env:VAR_SOURCE_PROJECT_REF
          if ([string]::IsNullOrWhiteSpace($defaultConsumerRef)) {
            $defaultConsumerRef = 'main'
          }
          $defaultConsumerSha = [string]$env:VAR_SOURCE_PROJECT_SHA
          $defaultLabviewProfile = [string]$env:VAR_LABVIEW_PROFILE
          if ([string]::IsNullOrWhiteSpace($defaultLabviewProfile)) {
            $defaultLabviewProfile = 'lv2026'
          }

          $eventInputs = $null
          if (-not [string]::IsNullOrWhiteSpace($env:EVENT_INPUTS_JSON) -and $env:EVENT_INPUTS_JSON -ne 'null') {
            $eventInputs = $env:EVENT_INPUTS_JSON | ConvertFrom-Json -ErrorAction Stop
          }

          function Get-DispatchInputValue {
            param(
              [Parameter(Mandatory = $true)]
              [string]$Name
            )

            if ($null -eq $eventInputs) {
              return ''
            }

            $property = $eventInputs.PSObject.Properties[$Name]
            if ($null -eq $property) {
              return ''
            }

            return [string]$property.Value
          }

          function Resolve-BoolString {
            param(
              [Parameter(Mandatory = $false)]
              [AllowEmptyString()]
              [string]$RawValue,
              [Parameter(Mandatory = $true)]
              [bool]$DefaultValue
            )

            if ([string]::IsNullOrWhiteSpace($RawValue)) {
              return $DefaultValue.ToString().ToLowerInvariant()
            }

            $normalized = $RawValue.Trim().ToLowerInvariant()
            switch ($normalized) {
              'true' { return 'true' }
              'false' { return 'false' }
              '1' { return 'true' }
              '0' { return 'false' }
              default { throw "Invalid boolean input value '$RawValue'. Expected true/false." }
            }
          }

          $isWorkflowDispatch = [string]::Equals($env:EVENT_NAME, 'workflow_dispatch', [System.StringComparison]::Ordinal)
          $isPushMain = [string]::Equals($env:EVENT_NAME, 'push', [System.StringComparison]::Ordinal)

          $releaseTag = $defaultReleaseTag
          $consumerRepo = $defaultConsumerRepo
          $consumerRef = $defaultConsumerRef
          $consumerSha = $defaultConsumerSha
          $runSelfHosted = 'true'
          $runBuildSpec = 'true'
          $labviewProfile = $defaultLabviewProfile
          $sourceLabviewVersionOverride = ''
          $runLv2020EdgeSmoke = 'false'

          if ($isWorkflowDispatch) {
            $dispatchReleaseTag = Get-DispatchInputValue -Name 'release_tag'
            if (-not [string]::IsNullOrWhiteSpace($dispatchReleaseTag)) {
              $releaseTag = $dispatchReleaseTag
            }

            $dispatchConsumerRepo = Get-DispatchInputValue -Name 'consumer_repo'
            if (-not [string]::IsNullOrWhiteSpace($dispatchConsumerRepo)) {
              $consumerRepo = $dispatchConsumerRepo
            }

            $dispatchConsumerRef = Get-DispatchInputValue -Name 'consumer_ref'
            if (-not [string]::IsNullOrWhiteSpace($dispatchConsumerRef)) {
              $consumerRef = $dispatchConsumerRef
            }

            $dispatchConsumerSha = Get-DispatchInputValue -Name 'consumer_sha'
            if (-not [string]::IsNullOrWhiteSpace($dispatchConsumerSha)) {
              $consumerSha = $dispatchConsumerSha
            }

            $runSelfHosted = Resolve-BoolString -RawValue (Get-DispatchInputValue -Name 'run_self_hosted') -DefaultValue $true
            $runBuildSpec = Resolve-BoolString -RawValue (Get-DispatchInputValue -Name 'run_build_spec') -DefaultValue $true

            $dispatchLabviewProfile = Get-DispatchInputValue -Name 'labview_profile'
            if (-not [string]::IsNullOrWhiteSpace($dispatchLabviewProfile)) {
              $labviewProfile = $dispatchLabviewProfile
            }

            $dispatchLvversionOverride = Get-DispatchInputValue -Name 'source_labview_version_override'
            if (-not [string]::IsNullOrWhiteSpace($dispatchLvversionOverride)) {
              $sourceLabviewVersionOverride = $dispatchLvversionOverride
            }

            $runLv2020EdgeSmoke = Resolve-BoolString -RawValue (Get-DispatchInputValue -Name 'run_lv2020_edge_smoke') -DefaultValue $false
          }

          if ([string]::IsNullOrWhiteSpace($releaseTag)) {
            throw 'Resolved release tag is empty.'
          }

          if ([string]::IsNullOrWhiteSpace($consumerRepo)) {
            throw "Resolved source project repository is empty. Provide workflow input 'consumer_repo' or repository variable 'LVIE_SOURCE_PROJECT_REPO'."
          }
          $consumerRepo = $consumerRepo.Trim()
          if ($consumerRepo -notmatch '^[^/\s]+/[^/\s]+$') {
            throw "Resolved source project repository '$consumerRepo' is invalid. Expected format '<owner>/<repo>'."
          }

          if ([string]::IsNullOrWhiteSpace($consumerRef)) {
            throw "Resolved source project ref is empty. Provide workflow input 'consumer_ref' or repository variable 'LVIE_SOURCE_PROJECT_REF'."
          }
          $consumerRef = $consumerRef.Trim()

          if ([string]::IsNullOrWhiteSpace($consumerSha)) {
            throw "Resolved source project SHA is empty. Strict pin is required; set workflow input 'consumer_sha' or repository variable 'LVIE_SOURCE_PROJECT_SHA'."
          }
          $consumerSha = $consumerSha.Trim().ToLowerInvariant()
          if ($consumerSha -notmatch '^[0-9a-f]{40}$') {
            throw "Resolved source project SHA '$consumerSha' is invalid. Expected 40-char lowercase hex."
          }

          $tagExists = $false
          $escapedTag = [System.Uri]::EscapeDataString($releaseTag)
          & gh api "repos/$env:GITHUB_REPOSITORY/git/ref/tags/$escapedTag" *> $null
          if ($LASTEXITCODE -eq 0) {
            $tagExists = $true
          }

          $shouldRelease = 'true'
          $skipReason = ''
          if ($isPushMain -and $tagExists) {
            $shouldRelease = 'false'
            $skipReason = 'tag_exists'
          }

          "release_tag=$releaseTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "consumer_repo=$consumerRepo" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "consumer_ref=$consumerRef" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "consumer_sha=$consumerSha" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "run_self_hosted=$runSelfHosted" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "run_build_spec=$runBuildSpec" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "labview_profile=$labviewProfile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "source_labview_version_override=$sourceLabviewVersionOverride" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "run_lv2020_edge_smoke=$runLv2020EdgeSmoke" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "should_release=$shouldRelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "skip_reason=$skipReason" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          $sourceLabviewOverrideDisplay = if ([string]::IsNullOrWhiteSpace($sourceLabviewVersionOverride)) { '<none>' } else { $sourceLabviewVersionOverride }
          $skipReasonDisplay = if ([string]::IsNullOrWhiteSpace($skipReason)) { '<none>' } else { $skipReason }
          $summary = @(
            '## Release context resolver'
            ''
            "- Event: $($env:EVENT_NAME)"
            "- Manifest version: $manifestVersion"
            "- Resolved release tag: $releaseTag"
            "- Source project repo: $consumerRepo"
            "- Source project ref: $consumerRef"
            "- Source project sha: $consumerSha"
            "- LabVIEW profile: $labviewProfile"
            "- source_labview_version_override: $sourceLabviewOverrideDisplay"
            "- run_lv2020_edge_smoke: $runLv2020EdgeSmoke"
            "- should_release: $shouldRelease"
            "- skip_reason: $skipReasonDisplay"
          ) -join [Environment]::NewLine
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

  ci-gate:
    needs: [resolve-release-context]
    if: ${{ needs.resolve-release-context.outputs.should_release == 'true' }}
    uses: ./.github/workflows/ci.yml
    with:
      source_project_repo: ${{ needs.resolve-release-context.outputs.consumer_repo }}
      source_project_ref: ${{ needs.resolve-release-context.outputs.consumer_ref }}
      source_project_sha: ${{ needs.resolve-release-context.outputs.consumer_sha }}
      labview_profile: ${{ needs.resolve-release-context.outputs.labview_profile }}
      source_labview_version_override: ${{ needs.resolve-release-context.outputs.source_labview_version_override }}
      run_lv2020_edge_smoke: ${{ needs.resolve-release-context.outputs.run_lv2020_edge_smoke }}
    secrets: inherit

  package:
    needs: [resolve-release-context, ci-gate]
    if: ${{ needs.resolve-release-context.outputs.should_release == 'true' }}
    runs-on: [self-hosted, windows, self-hosted-windows-lv]
    outputs:
      asset_name: ${{ steps.package.outputs.asset_name }}
      asset_path: ${{ steps.package.outputs.asset_path }}
      asset_sha256: ${{ steps.package.outputs.asset_sha256 }}
      nsis_root: ${{ steps.package.outputs.nsis_root }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: package
        name: Build layer installer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $assetName = 'lvie-codex-skill-layer-installer.exe'
          $staging = Join-Path $env:RUNNER_TEMP 'skill-layer'
          if (Test-Path $staging) { Remove-Item -Path $staging -Recurse -Force }
          New-Item -Path $staging -ItemType Directory -Force | Out-Null

          Copy-Item -Path "$env:GITHUB_WORKSPACE/ci-debt" -Destination "$staging/ci-debt" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/lunit-contract" -Destination "$staging/lunit-contract" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/proactive-loop" -Destination "$staging/proactive-loop" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/headless-parity" -Destination "$staging/headless-parity" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/linux-ppl-container-build" -Destination "$staging/linux-ppl-container-build" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/belt-suspenders" -Destination "$staging/belt-suspenders" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/vipm-cli-machine" -Destination "$staging/vipm-cli-machine" -Recurse -Force

          $manifestPath = Join-Path $staging 'manifest.json'
          $manifest = Get-Content -Raw -Path "$env:GITHUB_WORKSPACE/manifest.json" | ConvertFrom-Json
          $manifest.generated_utc = (Get-Date).ToUniversalTime().ToString('o')
          $manifest | ConvertTo-Json -Depth 10 | Out-File -FilePath $manifestPath -Encoding utf8

          Copy-Item -Path "$env:GITHUB_WORKSPACE/LICENSE" -Destination (Join-Path $staging 'LICENSE') -Force

          $assetPath = Join-Path $env:RUNNER_TEMP $assetName
          if (Test-Path $assetPath) { Remove-Item -Path $assetPath -Force }

          $installRoot = 'C:\Users\Public\lvie\codex-skill-layer\current'
          $buildScript = Join-Path $env:GITHUB_WORKSPACE 'scripts/Build-SkillLayerInstaller.ps1'
          if (-not (Test-Path -Path $buildScript -PathType Leaf)) {
            throw "Installer build script not found: $buildScript"
          }

          $nsisRoot = '${{ vars.NSIS_ROOT }}'
          if ([string]::IsNullOrWhiteSpace($nsisRoot)) {
            $nsisRoot = 'C:\Program Files (x86)\NSIS'
          }
          $makensis = Join-Path $nsisRoot 'makensis.exe'
          if (-not (Test-Path -Path $makensis -PathType Leaf)) {
            throw "Required NSIS binary not found at '$makensis'. Set repository variable NSIS_ROOT or install NSIS at C:\Program Files (x86)\NSIS."
          }

          & $makensis /VERSION
          if ($LASTEXITCODE -ne 0) {
            throw "makensis version probe failed with exit code $LASTEXITCODE"
          }

          & $buildScript -PayloadRoot $staging -OutputPath $assetPath -InstallRoot $installRoot -NsisRoot $nsisRoot
          if ($LASTEXITCODE -ne 0) {
            throw "Build-SkillLayerInstaller.ps1 failed with exit code $LASTEXITCODE"
          }

          $hash = (Get-FileHash -Path $assetPath -Algorithm SHA256).Hash.ToLowerInvariant()
          "asset_name=$assetName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "asset_path=$assetPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "asset_sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "nsis_root=$nsisRoot" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: codex-skill-layer
          path: ${{ steps.package.outputs.asset_path }}
          if-no-files-found: error

  publish-release-assets:
    needs: [resolve-release-context, ci-gate, package]
    if: ${{ needs.resolve-release-context.outputs.should_release == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: codex-skill-layer
          path: ${{ runner.temp }}/release-assets/installer

      - name: Download Windows PPL bundle artifact
        uses: actions/download-artifact@v4
        with:
          pattern: docker-contract-ppl-bundle-windows-x64-*
          path: ${{ runner.temp }}/release-assets/ppl-bundle-windows
          merge-multiple: true

      - name: Download Linux PPL bundle artifact
        uses: actions/download-artifact@v4
        with:
          pattern: docker-contract-ppl-bundle-linux-x64-*
          path: ${{ runner.temp }}/release-assets/ppl-bundle-linux
          merge-multiple: true

      - name: Download self-hosted VIP package artifact
        uses: actions/download-artifact@v4
        with:
          pattern: docker-contract-vip-package-self-hosted-*
          path: ${{ runner.temp }}/release-assets/vip-package-self-hosted
          merge-multiple: true

      - id: stage
        name: Stage release assets and provenance
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $releaseTag = '${{ needs.resolve-release-context.outputs.release_tag }}'
          if ([string]::IsNullOrWhiteSpace($releaseTag)) {
            throw 'release_tag input is required.'
          }

          $assetsRoot = Join-Path $env:RUNNER_TEMP 'release-assets'
          $stageDir = Join-Path $env:RUNNER_TEMP 'release-stage'
          if (Test-Path -LiteralPath $stageDir) {
            Remove-Item -LiteralPath $stageDir -Recurse -Force
          }
          New-Item -Path $stageDir -ItemType Directory -Force | Out-Null

          $installerDir = Join-Path $assetsRoot 'installer'
          $windowsBundleDir = Join-Path $assetsRoot 'ppl-bundle-windows'
          $linuxBundleDir = Join-Path $assetsRoot 'ppl-bundle-linux'
          $vipPackageDir = Join-Path $assetsRoot 'vip-package-self-hosted'

          foreach ($requiredDir in @($installerDir, $windowsBundleDir, $linuxBundleDir, $vipPackageDir)) {
            if (-not (Test-Path -LiteralPath $requiredDir -PathType Container)) {
              throw "Required release asset directory missing: $requiredDir"
            }
          }

          $installerFile = Get-ChildItem -LiteralPath $installerDir -File -Filter '*.exe' | Select-Object -First 1
          if ($null -eq $installerFile) {
            throw "Installer artifact does not contain an .exe file under '$installerDir'."
          }

          $stagedInstallerPath = Join-Path $stageDir 'lvie-codex-skill-layer-installer.exe'
          Copy-Item -LiteralPath $installerFile.FullName -Destination $stagedInstallerPath -Force

          $windowsZipPath = Join-Path $stageDir 'lvie-ppl-bundle-windows-x64.zip'
          if (Test-Path -LiteralPath $windowsZipPath -PathType Leaf) { Remove-Item -LiteralPath $windowsZipPath -Force }
          Compress-Archive -Path (Join-Path $windowsBundleDir '*') -DestinationPath $windowsZipPath

          $linuxZipPath = Join-Path $stageDir 'lvie-ppl-bundle-linux-x64.zip'
          if (Test-Path -LiteralPath $linuxZipPath -PathType Leaf) { Remove-Item -LiteralPath $linuxZipPath -Force }
          Compress-Archive -Path (Join-Path $linuxBundleDir '*') -DestinationPath $linuxZipPath

          $vipZipPath = Join-Path $stageDir 'lvie-vip-package-self-hosted.zip'
          if (Test-Path -LiteralPath $vipZipPath -PathType Leaf) { Remove-Item -LiteralPath $vipZipPath -Force }
          Compress-Archive -Path (Join-Path $vipPackageDir '*') -DestinationPath $vipZipPath

          $assetFiles = @(
            Get-Item -LiteralPath $stagedInstallerPath
            Get-Item -LiteralPath $windowsZipPath
            Get-Item -LiteralPath $linuxZipPath
            Get-Item -LiteralPath $vipZipPath
          )

          $assetRecords = foreach ($asset in $assetFiles) {
            [pscustomobject]@{
              name = $asset.Name
              size_bytes = [int64]$asset.Length
              sha256 = (Get-FileHash -LiteralPath $asset.FullName -Algorithm SHA256).Hash.ToLowerInvariant()
            }
          }

          $provenancePath = Join-Path $stageDir 'release-provenance.json'
          $provenance = [pscustomobject]@{
            schema_version = '1.0'
            generated_utc = (Get-Date).ToUniversalTime().ToString('o')
            release_tag = $releaseTag
            source_project = [pscustomobject]@{
              repo = '${{ needs.resolve-release-context.outputs.consumer_repo }}'
              ref = '${{ needs.resolve-release-context.outputs.consumer_ref }}'
              sha = '${{ needs.resolve-release-context.outputs.consumer_sha }}'
            }
            skills_ci_run = [pscustomobject]@{
              repository = '${{ github.repository }}'
              run_id = '${{ github.run_id }}'
              run_attempt = '${{ github.run_attempt }}'
              run_url = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            }
            release_workflow = [pscustomobject]@{
              run_self_hosted = '${{ needs.resolve-release-context.outputs.run_self_hosted }}'
              run_build_spec = '${{ needs.resolve-release-context.outputs.run_build_spec }}'
              source_labview_version_override = '${{ needs.resolve-release-context.outputs.source_labview_version_override }}'
              run_lv2020_edge_smoke = '${{ needs.resolve-release-context.outputs.run_lv2020_edge_smoke }}'
              nsis_root = '${{ needs.package.outputs.nsis_root }}'
            }
            assets = $assetRecords
          }
          $provenance | ConvertTo-Json -Depth 10 | Set-Content -LiteralPath $provenancePath -Encoding UTF8

          $payloadManifestScript = Join-Path $env:GITHUB_WORKSPACE 'scripts/New-ReleasePayloadManifest.ps1'
          if (-not (Test-Path -LiteralPath $payloadManifestScript -PathType Leaf)) {
            throw "Release payload manifest script not found: $payloadManifestScript"
          }
          $payloadManifestSchema = Join-Path $env:GITHUB_WORKSPACE 'schemas/release-payload-contract.schema.json'
          if (-not (Test-Path -LiteralPath $payloadManifestSchema -PathType Leaf)) {
            throw "Release payload manifest schema not found: $payloadManifestSchema"
          }
          $payloadManifestPath = Join-Path $stageDir 'release-payload-manifest.json'

          & $payloadManifestScript `
            -ReleaseTag $releaseTag `
            -StageDirectory $stageDir `
            -SourceProjectRepo '${{ needs.resolve-release-context.outputs.consumer_repo }}' `
            -SourceProjectRef '${{ needs.resolve-release-context.outputs.consumer_ref }}' `
            -SourceProjectSha '${{ needs.resolve-release-context.outputs.consumer_sha }}' `
            -CiRepository '${{ github.repository }}' `
            -CiRunId '${{ github.run_id }}' `
            -CiRunAttempt '${{ github.run_attempt }}' `
            -CiRunUrl 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}' `
            -OutputPath $payloadManifestPath `
            -SchemaPath $payloadManifestSchema

          $provenanceSha = (Get-FileHash -LiteralPath $provenancePath -Algorithm SHA256).Hash.ToLowerInvariant()
          $payloadManifestSha = (Get-FileHash -LiteralPath $payloadManifestPath -Algorithm SHA256).Hash.ToLowerInvariant()

          $notesPath = Join-Path $env:RUNNER_TEMP 'release-notes.md'
          $notes = @(
            'Layered Codex skill asset for labview-icon-editor.',
            '',
            'Release assets:',
            "- lvie-codex-skill-layer-installer.exe (SHA256: $($assetRecords | Where-Object { $_.name -eq 'lvie-codex-skill-layer-installer.exe' } | Select-Object -ExpandProperty sha256))",
            "- lvie-ppl-bundle-windows-x64.zip (SHA256: $($assetRecords | Where-Object { $_.name -eq 'lvie-ppl-bundle-windows-x64.zip' } | Select-Object -ExpandProperty sha256))",
            "- lvie-ppl-bundle-linux-x64.zip (SHA256: $($assetRecords | Where-Object { $_.name -eq 'lvie-ppl-bundle-linux-x64.zip' } | Select-Object -ExpandProperty sha256))",
            "- lvie-vip-package-self-hosted.zip (SHA256: $($assetRecords | Where-Object { $_.name -eq 'lvie-vip-package-self-hosted.zip' } | Select-Object -ExpandProperty sha256))",
            "- release-provenance.json (SHA256: $provenanceSha)",
            "- release-payload-manifest.json (SHA256: $payloadManifestSha)",
            '',
            'CI provenance:',
            '- skills_ci_repo: ${{ github.repository }}',
            '- skills_ci_run_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}',
            '- skills_ci_run_id: ${{ github.run_id }}',
            '- skills_ci_run_attempt: ${{ github.run_attempt }}',
            '- source_project_repo: ${{ needs.resolve-release-context.outputs.consumer_repo }}',
            '- source_project_ref: ${{ needs.resolve-release-context.outputs.consumer_ref }}',
            '- source_project_sha: ${{ needs.resolve-release-context.outputs.consumer_sha }}',
            '- source_labview_version_override: ${{ needs.resolve-release-context.outputs.source_labview_version_override }}',
            '- run_lv2020_edge_smoke: ${{ needs.resolve-release-context.outputs.run_lv2020_edge_smoke }}',
            '- nsis_root: ${{ needs.package.outputs.nsis_root }}',
            '- run_self_hosted: ${{ needs.resolve-release-context.outputs.run_self_hosted }} (deprecated)',
            '- run_build_spec: ${{ needs.resolve-release-context.outputs.run_build_spec }} (deprecated)'
          ) -join [Environment]::NewLine
          Set-Content -LiteralPath $notesPath -Value $notes -Encoding UTF8

          "stage_dir=$stageDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "notes_path=$notesPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Publish release assets
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = '${{ needs.resolve-release-context.outputs.release_tag }}'
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw 'release_tag input is required.'
          }

          $stageDir = '${{ steps.stage.outputs.stage_dir }}'
          if (-not (Test-Path -LiteralPath $stageDir -PathType Container)) {
            throw "Staged release directory not found: $stageDir"
          }

          $assetPaths = @(Get-ChildItem -LiteralPath $stageDir -File | Sort-Object Name | ForEach-Object { $_.FullName })
          if ($assetPaths.Count -eq 0) {
            throw "No release assets found under '$stageDir'."
          }

          $notesPath = '${{ steps.stage.outputs.notes_path }}'
          if (-not (Test-Path -LiteralPath $notesPath -PathType Leaf)) {
            throw "Release notes file not found: $notesPath"
          }

          gh release view $tag --repo $env:GITHUB_REPOSITORY *> $null
          if ($LASTEXITCODE -eq 0) {
            & gh release edit $tag --repo $env:GITHUB_REPOSITORY --title $tag --notes-file $notesPath
            & gh release upload $tag @assetPaths --repo $env:GITHUB_REPOSITORY --clobber
          } else {
            & gh release create $tag @assetPaths --repo $env:GITHUB_REPOSITORY --title $tag --notes-file $notesPath
          }

  release-skipped:
    needs: [resolve-release-context]
    if: ${{ needs.resolve-release-context.outputs.should_release != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $releaseTag = '${{ needs.resolve-release-context.outputs.release_tag }}'
          $skipReason = '${{ needs.resolve-release-context.outputs.skip_reason }}'
          if ([string]::IsNullOrWhiteSpace($skipReason)) {
            $skipReason = 'n/a'
          }

          @(
            '## release-skill-layer skipped'
            ''
            "- Resolved release tag: $releaseTag"
            "- Reason: $skipReason"
            '- Behavior: deterministic auto-release skip path (non-failure).'
          ) -join [Environment]::NewLine | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

