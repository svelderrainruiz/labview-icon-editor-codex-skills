name: release-skill-layer

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to publish (for example, v0.4.0).
        required: true
        type: string
      consumer_repo:
        description: Consumer repository that owns the parity gate run.
        required: true
        default: svelderrainruiz/labview-icon-editor
        type: string
      consumer_ref:
        description: Consumer ref to dispatch parity against (branch/tag/ref).
        required: true
        type: string
      consumer_sha:
        description: Consumer commit SHA that parity must validate.
        required: true
        type: string
      run_self_hosted:
        description: Require self-hosted parity lane in the consumer parity run.
        required: false
        default: true
        type: boolean
      run_build_spec:
        description: Require build-spec parity execution in the consumer parity run.
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  parity-gate:
    uses: ./.github/workflows/labview-parity.yml
    with:
      consumer_repo: ${{ inputs.consumer_repo }}
      consumer_ref: ${{ inputs.consumer_ref }}
      consumer_sha: ${{ inputs.consumer_sha }}
      run_self_hosted: ${{ inputs.run_self_hosted }}
      run_build_spec: ${{ inputs.run_build_spec }}
    secrets: inherit

  package:
    needs: [parity-gate]
    runs-on: [self-hosted, windows, self-hosted-windows-lv]
    outputs:
      asset_name: ${{ steps.package.outputs.asset_name }}
      asset_path: ${{ steps.package.outputs.asset_path }}
      asset_sha256: ${{ steps.package.outputs.asset_sha256 }}
      nsis_root: ${{ steps.package.outputs.nsis_root }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: package
        name: Build layer installer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $assetName = 'lvie-codex-skill-layer-installer.exe'
          $staging = Join-Path $env:RUNNER_TEMP 'skill-layer'
          if (Test-Path $staging) { Remove-Item -Path $staging -Recurse -Force }
          New-Item -Path $staging -ItemType Directory -Force | Out-Null

          Copy-Item -Path "$env:GITHUB_WORKSPACE/ci-debt" -Destination "$staging/ci-debt" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/lunit-contract" -Destination "$staging/lunit-contract" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/proactive-loop" -Destination "$staging/proactive-loop" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/headless-parity" -Destination "$staging/headless-parity" -Recurse -Force
          Copy-Item -Path "$env:GITHUB_WORKSPACE/belt-suspenders" -Destination "$staging/belt-suspenders" -Recurse -Force

          $manifestPath = Join-Path $staging 'manifest.json'
          $manifest = Get-Content -Raw -Path "$env:GITHUB_WORKSPACE/manifest.json" | ConvertFrom-Json
          $manifest.generated_utc = (Get-Date).ToUniversalTime().ToString('o')
          $manifest | ConvertTo-Json -Depth 10 | Out-File -FilePath $manifestPath -Encoding utf8

          Copy-Item -Path "$env:GITHUB_WORKSPACE/LICENSE" -Destination (Join-Path $staging 'LICENSE') -Force

          $assetPath = Join-Path $env:RUNNER_TEMP $assetName
          if (Test-Path $assetPath) { Remove-Item -Path $assetPath -Force }

          $installRoot = 'C:\Users\Public\lvie\codex-skill-layer\current'
          $buildScript = Join-Path $env:GITHUB_WORKSPACE 'scripts/Build-SkillLayerInstaller.ps1'
          if (-not (Test-Path -Path $buildScript -PathType Leaf)) {
            throw "Installer build script not found: $buildScript"
          }

          $nsisRoot = '${{ vars.NSIS_ROOT }}'
          if ([string]::IsNullOrWhiteSpace($nsisRoot)) {
            $nsisRoot = 'C:\Program Files (x86)\NSIS'
          }
          $makensis = Join-Path $nsisRoot 'makensis.exe'
          if (-not (Test-Path -Path $makensis -PathType Leaf)) {
            throw "Required NSIS binary not found at '$makensis'. Set repository variable NSIS_ROOT or install NSIS at C:\Program Files (x86)\NSIS."
          }

          & $makensis /VERSION
          if ($LASTEXITCODE -ne 0) {
            throw "makensis version probe failed with exit code $LASTEXITCODE"
          }

          & $buildScript -PayloadRoot $staging -OutputPath $assetPath -InstallRoot $installRoot -NsisRoot $nsisRoot
          if ($LASTEXITCODE -ne 0) {
            throw "Build-SkillLayerInstaller.ps1 failed with exit code $LASTEXITCODE"
          }

          $hash = (Get-FileHash -Path $assetPath -Algorithm SHA256).Hash.ToLowerInvariant()
          "asset_name=$assetName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "asset_path=$assetPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "asset_sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "nsis_root=$nsisRoot" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: codex-skill-layer
          path: ${{ steps.package.outputs.asset_path }}
          if-no-files-found: error

      - name: Publish release asset
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = '${{ inputs.release_tag }}'
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw 'release_tag input is required.'
          }

          $assetPath = '${{ steps.package.outputs.asset_path }}'
          if (-not (Test-Path -Path $assetPath -PathType Leaf)) {
            throw "Packaged asset not found: $assetPath"
          }

          $notes = @(
            'Layered Codex skill asset for labview-icon-editor.',
            '',
            '- Asset: lvie-codex-skill-layer-installer.exe',
            '- SHA256: ${{ steps.package.outputs.asset_sha256 }}',
            '- License: 0BSD',
            '',
            'Release provenance:',
            "- consumer_repo: ${{ inputs.consumer_repo }}",
            "- consumer_ref: ${{ inputs.consumer_ref }}",
            "- consumer_sha: ${{ inputs.consumer_sha }}",
            "- parity_run_url: ${{ needs.parity-gate.outputs.parity_run_url }}",
            "- parity_run_id: ${{ needs.parity-gate.outputs.parity_run_id }}",
            "- parity_head_sha: ${{ needs.parity-gate.outputs.parity_head_sha }}",
            "- nsis_root: ${{ steps.package.outputs.nsis_root }}"
          ) -join [Environment]::NewLine

          gh release view $tag --repo $env:GITHUB_REPOSITORY *> $null
          if ($LASTEXITCODE -eq 0) {
            gh release upload $tag $assetPath --repo $env:GITHUB_REPOSITORY --clobber
          } else {
            gh release create $tag $assetPath --repo $env:GITHUB_REPOSITORY --title $tag --notes $notes
          }
