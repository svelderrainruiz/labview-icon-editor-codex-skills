name: labview-parity-gate

on:
  workflow_dispatch:
    inputs:
      consumer_repo:
        description: Consumer repository that owns the parity workflow.
        required: true
        default: svelderrainruiz/labview-icon-editor
        type: string
      consumer_ref:
        description: Consumer ref to dispatch parity against.
        required: true
        type: string
      consumer_sha:
        description: Consumer commit SHA that parity must validate.
        required: true
        type: string
      run_self_hosted:
        description: Require self-hosted parity lane in the consumer run.
        required: false
        default: true
        type: boolean
      run_build_spec:
        description: Require build-spec parity lane execution.
        required: false
        default: true
        type: boolean
  workflow_call:
    inputs:
      consumer_repo:
        required: true
        type: string
      consumer_ref:
        required: true
        type: string
      consumer_sha:
        required: true
        type: string
      run_self_hosted:
        required: false
        default: true
        type: boolean
      run_build_spec:
        required: false
        default: true
        type: boolean
    outputs:
      consumer_sandbox_checked_sha:
        description: Consumer SHA observed from sandbox checkout.
        value: ${{ jobs.consumer-sandbox-preflight.outputs.consumer_checked_sha }}
      consumer_sandbox_evidence_artifact:
        description: Sandbox evidence artifact name emitted by preflight.
        value: ${{ jobs.consumer-sandbox-preflight.outputs.sandbox_evidence_artifact_name }}
      gate_repo:
        description: Repository that produced this parity gate evidence.
        value: ${{ jobs.parity-gate.outputs.gate_repo }}
      gate_run_id:
        description: Skills parity gate run identifier.
        value: ${{ jobs.parity-gate.outputs.gate_run_id }}
      gate_run_url:
        description: Skills parity gate run URL.
        value: ${{ jobs.parity-gate.outputs.gate_run_url }}
      gate_run_attempt:
        description: Skills parity gate run attempt.
        value: ${{ jobs.parity-gate.outputs.gate_run_attempt }}
      parity_run_id:
        description: Dispatched consumer parity run identifier.
        value: ${{ jobs.parity-gate.outputs.parity_run_id }}
      parity_run_url:
        description: Dispatched consumer parity run URL.
        value: ${{ jobs.parity-gate.outputs.parity_run_url }}
      parity_head_sha:
        description: Head SHA reported by the consumer parity run.
        value: ${{ jobs.parity-gate.outputs.parity_head_sha }}
      parity_enforcement_profile:
        description: Effective parity policy profile used by the gate.
        value: ${{ jobs.parity-gate.outputs.parity_enforcement_profile }}
      parity_gate_passed:
        description: True when parity gate validations passed.
        value: ${{ jobs.parity-gate.outputs.parity_gate_passed }}

permissions:
  contents: read

jobs:
  consumer-sandbox-preflight:
    runs-on: ubuntu-latest
    outputs:
      consumer_checked_sha: ${{ steps.inspect.outputs.consumer_checked_sha }}
      parity_enforcement_profile: ${{ steps.inspect.outputs.parity_enforcement_profile }}
      sandbox_evidence_artifact_name: ${{ steps.inspect.outputs.sandbox_evidence_artifact_name }}
    steps:
      - name: Checkout consumer repository snapshot
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.consumer_repo }}
          ref: ${{ inputs.consumer_ref }}
          path: consumer
          fetch-depth: 0

      - id: inspect
        name: Validate sandbox contract and emit evidence
        env:
          CONSUMER_REPO: ${{ inputs.consumer_repo }}
          CONSUMER_REF: ${{ inputs.consumer_ref }}
          CONSUMER_SHA: ${{ inputs.consumer_sha }}
        shell: bash
        run: |
          set -euo pipefail

          consumer_dir="$GITHUB_WORKSPACE/consumer"
          if [[ ! -d "$consumer_dir/.git" ]]; then
            echo "Consumer sandbox checkout is missing: $consumer_dir" >&2
            exit 1
          fi

          consumer_checked_sha="$(git -C "$consumer_dir" rev-parse HEAD)"
          if [[ "$consumer_checked_sha" != "$CONSUMER_SHA" ]]; then
            echo "Sandbox preflight failed: checked out SHA '$consumer_checked_sha' does not match expected '$CONSUMER_SHA'." >&2
            exit 1
          fi

          lvversion_path="$consumer_dir/.lvversion"
          if [[ ! -f "$lvversion_path" ]]; then
            echo "Sandbox preflight failed: missing .lvversion at '$lvversion_path'." >&2
            exit 1
          fi
          lvversion_raw="$(tr -d '\r\n' < "$lvversion_path" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ -z "$lvversion_raw" ]]; then
            echo "Sandbox preflight failed: .lvversion is empty." >&2
            exit 1
          fi
          if ! [[ "$lvversion_raw" =~ ^([0-9]{2}\.[0-9]+|[0-9]{4})$ ]]; then
            echo "Sandbox preflight failed: .lvversion '$lvversion_raw' is not in an accepted format (NN.N or YYYY)." >&2
            exit 1
          fi

          workflow_path="$consumer_dir/.github/workflows/labview-parity.yml"
          if [[ ! -f "$workflow_path" ]]; then
            echo "Sandbox preflight failed: missing consumer workflow '$workflow_path'." >&2
            exit 1
          fi

          if [[ "$CONSUMER_REPO" == "svelderrainruiz/labview-icon-editor" ]]; then
            parity_enforcement_profile="upstream-strict"
            required_jobs=(
              "Parity (Linux Container)"
              "Parity (Self-Hosted Runner)"
              "Parity (Windows Container)"
            )
          else
            parity_enforcement_profile="fork-container-only"
            required_jobs=(
              "Parity (Linux Container)"
              "Parity (Windows Container)"
            )
          fi

          for job_name in "${required_jobs[@]}"; do
            if ! grep -Fq "$job_name" "$workflow_path"; then
              echo "Sandbox preflight failed: consumer workflow missing required parity job '$job_name' for profile '$parity_enforcement_profile'." >&2
              exit 1
            fi
          done

          workflow_sha256="$(sha256sum "$workflow_path" | awk '{print $1}')"
          required_jobs_json="$(printf '%s\n' "${required_jobs[@]}" | jq -R . | jq -s .)"
          evidence_path="$RUNNER_TEMP/sandbox-contract-evidence.json"
          timestamp_utc="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          sandbox_evidence_artifact_name="consumer-sandbox-evidence"

          jq -n \
            --arg timestamp_utc "$timestamp_utc" \
            --arg consumer_repo "$CONSUMER_REPO" \
            --arg consumer_ref "$CONSUMER_REF" \
            --arg consumer_sha "$CONSUMER_SHA" \
            --arg consumer_checked_sha "$consumer_checked_sha" \
            --arg parity_enforcement_profile "$parity_enforcement_profile" \
            --arg lvversion_raw "$lvversion_raw" \
            --arg workflow_sha256 "$workflow_sha256" \
            --argjson required_jobs "$required_jobs_json" \
            '{
              timestamp_utc: $timestamp_utc,
              consumer_repo: $consumer_repo,
              consumer_ref: $consumer_ref,
              consumer_sha: $consumer_sha,
              consumer_checked_sha: $consumer_checked_sha,
              parity_enforcement_profile: $parity_enforcement_profile,
              lvversion_raw: $lvversion_raw,
              consumer_parity_workflow_sha256: $workflow_sha256,
              required_jobs: $required_jobs
            }' > "$evidence_path"

          echo "consumer_checked_sha=$consumer_checked_sha" >> "$GITHUB_OUTPUT"
          echo "parity_enforcement_profile=$parity_enforcement_profile" >> "$GITHUB_OUTPUT"
          echo "sandbox_evidence_path=$evidence_path" >> "$GITHUB_OUTPUT"
          echo "sandbox_evidence_artifact_name=$sandbox_evidence_artifact_name" >> "$GITHUB_OUTPUT"

      - name: Upload sandbox evidence artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.inspect.outputs.sandbox_evidence_artifact_name }}
          path: ${{ steps.inspect.outputs.sandbox_evidence_path }}
          if-no-files-found: error

  parity-gate:
    needs: [consumer-sandbox-preflight]
    runs-on: ubuntu-latest
    outputs:
      gate_repo: ${{ steps.gate-meta.outputs.gate_repo }}
      gate_run_id: ${{ steps.gate-meta.outputs.gate_run_id }}
      gate_run_url: ${{ steps.gate-meta.outputs.gate_run_url }}
      gate_run_attempt: ${{ steps.gate-meta.outputs.gate_run_attempt }}
      parity_run_id: ${{ steps.resolve.outputs.parity_run_id }}
      parity_run_url: ${{ steps.verify.outputs.parity_run_url }}
      parity_head_sha: ${{ steps.verify.outputs.parity_head_sha }}
      parity_enforcement_profile: ${{ steps.verify.outputs.parity_enforcement_profile }}
      parity_gate_passed: ${{ steps.verify.outputs.parity_gate_passed }}
    steps:
      - id: gate-meta
        name: Capture gate run metadata
        shell: bash
        run: |
          set -euo pipefail
          echo "gate_repo=$GITHUB_REPOSITORY" >> "$GITHUB_OUTPUT"
          echo "gate_run_id=$GITHUB_RUN_ID" >> "$GITHUB_OUTPUT"
          echo "gate_run_attempt=$GITHUB_RUN_ATTEMPT" >> "$GITHUB_OUTPUT"
          echo "gate_run_url=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Validate parity gate token
        env:
          LVIE_PARITY_GATE_TOKEN: ${{ secrets.LVIE_PARITY_GATE_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${LVIE_PARITY_GATE_TOKEN:-}" ]]; then
            echo "Missing required secret LVIE_PARITY_GATE_TOKEN." >&2
            echo "Configure a token with repo+workflow scopes for cross-repo parity dispatch." >&2
            exit 1
          fi

      - id: dispatch
        name: Dispatch consumer parity workflow
        env:
          GH_TOKEN: ${{ secrets.LVIE_PARITY_GATE_TOKEN }}
          CONSUMER_REPO: ${{ inputs.consumer_repo }}
          CONSUMER_REF: ${{ inputs.consumer_ref }}
          CONSUMER_SHA: ${{ inputs.consumer_sha }}
          RUN_BUILD_SPEC: ${{ inputs.run_build_spec }}
          RUN_SELF_HOSTED: ${{ inputs.run_self_hosted }}
          PRECHECK_PROFILE: ${{ needs.consumer-sandbox-preflight.outputs.parity_enforcement_profile }}
        shell: bash
        run: |
          set -euo pipefail
          started_at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          dispatch_run_self_hosted="$RUN_SELF_HOSTED"
          if [[ "$PRECHECK_PROFILE" == "fork-container-only" ]]; then
            dispatch_run_self_hosted="false"
          fi

          echo "started_at=$started_at" >> "$GITHUB_OUTPUT"
          gh workflow run "LabVIEW Parity" \
            --repo "$CONSUMER_REPO" \
            --ref "$CONSUMER_REF" \
            -f run_build_spec="$RUN_BUILD_SPEC" \
            -f run_self_hosted="$dispatch_run_self_hosted" \
            -f expected_sha="$CONSUMER_SHA"

      - id: resolve
        name: Resolve dispatched consumer run id
        env:
          GH_TOKEN: ${{ secrets.LVIE_PARITY_GATE_TOKEN }}
          CONSUMER_REPO: ${{ inputs.consumer_repo }}
          CONSUMER_SHA: ${{ inputs.consumer_sha }}
          STARTED_AT: ${{ steps.dispatch.outputs.started_at }}
        shell: bash
        run: |
          set -euo pipefail
          deadline=$((SECONDS + 900))
          parity_run_id=""

          while [[ $SECONDS -lt $deadline ]]; do
            runs_json="$(gh run list \
              --repo "$CONSUMER_REPO" \
              --workflow "LabVIEW Parity" \
              --event workflow_dispatch \
              --limit 50 \
              --json databaseId,headSha,createdAt,url,status)"

            parity_run_id="$(echo "$runs_json" | jq -r --arg sha "$CONSUMER_SHA" --arg started "$STARTED_AT" '[.[] | select(.headSha == $sha and .createdAt >= $started)] | sort_by(.createdAt) | reverse | .[0].databaseId // empty')"

            if [[ -n "$parity_run_id" ]]; then
              break
            fi

            sleep 10
          done

          if [[ -z "$parity_run_id" ]]; then
            echo "Unable to resolve dispatched LabVIEW Parity run for sha '$CONSUMER_SHA' in '$CONSUMER_REPO'." >&2
            exit 1
          fi

          echo "parity_run_id=$parity_run_id" >> "$GITHUB_OUTPUT"

      - name: Wait for consumer parity completion
        env:
          GH_TOKEN: ${{ secrets.LVIE_PARITY_GATE_TOKEN }}
          CONSUMER_REPO: ${{ inputs.consumer_repo }}
          PARITY_RUN_ID: ${{ steps.resolve.outputs.parity_run_id }}
        shell: bash
        run: |
          set -euo pipefail
          gh run watch "$PARITY_RUN_ID" --repo "$CONSUMER_REPO"

      - id: verify
        name: Verify consumer parity run contract
        env:
          GH_TOKEN: ${{ secrets.LVIE_PARITY_GATE_TOKEN }}
          CONSUMER_REPO: ${{ inputs.consumer_repo }}
          CONSUMER_SHA: ${{ inputs.consumer_sha }}
          PARITY_RUN_ID: ${{ steps.resolve.outputs.parity_run_id }}
          PRECHECK_PROFILE: ${{ needs.consumer-sandbox-preflight.outputs.parity_enforcement_profile }}
        shell: bash
        run: |
          set -euo pipefail

          run_json="$(gh run view "$PARITY_RUN_ID" --repo "$CONSUMER_REPO" --json conclusion,headSha,url,jobs)"
          run_conclusion="$(echo "$run_json" | jq -r '.conclusion // empty')"
          run_head_sha="$(echo "$run_json" | jq -r '.headSha // empty')"
          run_url="$(echo "$run_json" | jq -r '.url // empty')"

          if [[ "$run_head_sha" != "$CONSUMER_SHA" ]]; then
            echo "Parity gate failed: run headSha '$run_head_sha' does not match expected '$CONSUMER_SHA'." >&2
            exit 1
          fi

          if [[ "$run_conclusion" != "success" ]]; then
            echo "Parity gate failed: run conclusion is '$run_conclusion' (expected success)." >&2
            echo "Run URL: $run_url" >&2
            exit 1
          fi

          if [[ "$PRECHECK_PROFILE" == "upstream-strict" ]]; then
            parity_enforcement_profile="upstream-strict"
            required_jobs=(
              "Parity (Linux Container)"
              "Parity (Self-Hosted Runner)"
              "Parity (Windows Container)"
            )
          elif [[ "$PRECHECK_PROFILE" == "fork-container-only" ]]; then
            parity_enforcement_profile="fork-container-only"
            required_jobs=(
              "Parity (Linux Container)"
              "Parity (Windows Container)"
            )
          else
            echo "Parity gate failed: unknown preflight enforcement profile '$PRECHECK_PROFILE'." >&2
            exit 1
          fi

          for job_name in "${required_jobs[@]}"; do
            job_conclusion="$(echo "$run_json" | jq -r --arg n "$job_name" '[.jobs[] | select(.name == $n) | .conclusion][0] // empty')"
            if [[ -z "$job_conclusion" ]]; then
              echo "Parity gate failed: required job '$job_name' is missing." >&2
              exit 1
            fi
            if [[ "$job_conclusion" != "success" ]]; then
              echo "Parity gate failed: required job '$job_name' concluded '$job_conclusion'." >&2
              exit 1
            fi
          done

          echo "parity_run_url=$run_url" >> "$GITHUB_OUTPUT"
          echo "parity_head_sha=$run_head_sha" >> "$GITHUB_OUTPUT"
          echo "parity_enforcement_profile=$parity_enforcement_profile" >> "$GITHUB_OUTPUT"
          echo "parity_gate_passed=true" >> "$GITHUB_OUTPUT"
