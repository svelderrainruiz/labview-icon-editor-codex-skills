name: docker-contract-ci

on:
  pull_request:
    paths:
      - 'tests/**'
      - 'schemas/**'
      - 'scripts/**'
      - 'vipm-cli-machine/**'
      - 'docker/**'
      - 'docs/**'
      - 'manifest.json'
      - 'README.md'
      - '.github/workflows/docker-contract-ci.yml'
  workflow_dispatch:

permissions:
  contents: read

env:
  CONSUMER_REPO: svelderrainruiz/labview-icon-editor
  CONSUMER_REF: patch/456-2020-migration-branch-from-9e46ecf
  CONSUMER_EXPECTED_SHA: 9e46ecf591bc36afca8ddf4ce688a5f58604a12a
  WINDOWS_LABVIEW_IMAGE: nationalinstruments/labview:2026q1-windows
  LINUX_LABVIEW_IMAGE: nationalinstruments/labview:2026q1-linux-pwsh
  WINDOWS_PPL_OUTPUT_PATH: consumer/resource/plugins/lv_icon.windows.lvlibp
  LINUX_PPL_OUTPUT_PATH: consumer/resource/plugins/lv_icon.linux.lvlibp
  LABVIEW_VERSION: '2026'
  BITNESS: '64'

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run contract tests in Docker
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/Invoke-DockerContractCI.ps1 `
            -DockerImage 'mcr.microsoft.com/powershell:7.4-ubuntu-22.04' `
            -TestPath './tests/*.Tests.ps1'

      - name: Build NI image with PowerShell and pinned Pester
        shell: bash
        run: |
          set -euo pipefail
          docker build -t "$LINUX_LABVIEW_IMAGE" -f docker/ni-lv-pwsh.Dockerfile .

      - name: Run VIPM activation contract tests on NI image
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/Invoke-DockerContractCI.ps1 `
            -DockerImage $env:LINUX_LABVIEW_IMAGE `
            -TestPath './tests/VipmCliActivationContract.Tests.ps1'

  build-ppl-windows:
    runs-on: windows-latest
    needs: [contract-tests]
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - name: Validate Windows container parity assets
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $required = Join-Path $env:GITHUB_WORKSPACE 'consumer/Tooling/container-parity/runlabview-windows.ps1'
          if (-not (Test-Path -LiteralPath $required -PathType Leaf)) {
            throw "Missing required consumer script '$required'."
          }

      - name: Build Windows PPL in NI Windows container
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $windowsPplOutputRelativePath = $env:WINDOWS_PPL_OUTPUT_PATH
          if ($windowsPplOutputRelativePath.StartsWith('consumer/')) {
            $windowsPplOutputRelativePath = $windowsPplOutputRelativePath.Substring('consumer/'.Length)
          }
          $windowsPplOutputRelativePath = $windowsPplOutputRelativePath -replace '/', '\'

          docker image inspect "$env:WINDOWS_LABVIEW_IMAGE" *> $null
          if ($LASTEXITCODE -ne 0) {
            docker pull "$env:WINDOWS_LABVIEW_IMAGE"
          }
          if ($LASTEXITCODE -ne 0) {
            throw "Unable to pull/access Windows LabVIEW image '$env:WINDOWS_LABVIEW_IMAGE'. Ensure the image exists and runner authentication is configured."
          }

          $consumerWorkspace = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          docker run --rm `
            -v "${consumerWorkspace}:C:\workspace" `
            -e LVIE_REPO_ROOT=C:\workspace `
            -e WORKSPACE_ROOT=C:\workspace `
            -e REPO_ROOT=C:\workspace `
            -e "LVIE_PROJECT_RELATIVE_PATH=lv_icon_editor.lvproj" `
            -e "PROJECT_PATH_REL=lv_icon_editor.lvproj" `
            -e "LVIE_PROJECT_PATH=C:\workspace\lv_icon_editor.lvproj" `
            -e "PROJECT_PATH=C:\workspace\lv_icon_editor.lvproj" `
            -e "TARGET_DIR_REL=Test\Templates" `
            -e "CONTAINER_PARITY_EXCLUDE_FILES=Polymorphic Template.vi" `
            -e "CONTAINER_PARITY_BUILD_SPEC=true" `
            -e "CONTAINER_PARITY_BUILD_SPEC_NAME=Editor Packed Library" `
            -e "CONTAINER_PARITY_TARGET_NAME=My Computer" `
            -e "CONTAINER_PARITY_BUILD_OUTPUT_RELATIVE_PATH=$windowsPplOutputRelativePath" `
            -e "CONTAINER_PARITY_LABVIEW_VERSION=$env:LABVIEW_VERSION" `
            "$env:WINDOWS_LABVIEW_IMAGE" `
            powershell -NoProfile -ExecutionPolicy Bypass -File C:\workspace\Tooling\container-parity\runlabview-windows.ps1

          if ($LASTEXITCODE -ne 0) {
            throw "Windows PPL build command failed with exit code $LASTEXITCODE"
          }

      - name: Create Windows PPL bundle manifest
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pplPath = Join-Path $env:GITHUB_WORKSPACE $env:WINDOWS_PPL_OUTPUT_PATH
          if (-not (Test-Path -LiteralPath $pplPath -PathType Leaf)) {
            throw "Windows PPL output not found at '$pplPath'."
          }

          $bundleDir = Join-Path $env:RUNNER_TEMP 'ppl-bundle-windows'
          if (Test-Path -LiteralPath $bundleDir) {
            Remove-Item -LiteralPath $bundleDir -Recurse -Force
          }
          New-Item -Path $bundleDir -ItemType Directory -Force | Out-Null

          & "$env:GITHUB_WORKSPACE/scripts/New-PplBundleManifest.ps1" `
            -PplPath $pplPath `
            -OutputDirectory $bundleDir `
            -LabVIEWVersion $env:LABVIEW_VERSION `
            -Bitness $env:BITNESS `
            -WindowsImage $env:WINDOWS_LABVIEW_IMAGE `
            -BuildRunId "$env:GITHUB_RUN_ID" `
            -BuildRunAttempt "$env:GITHUB_RUN_ATTEMPT"

      - name: Upload Windows PPL bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-ppl-bundle-windows-${{ github.run_id }}
          path: ${{ runner.temp }}/ppl-bundle-windows
          if-no-files-found: error

  build-ppl-linux:
    runs-on: ubuntu-latest
    needs: [contract-tests, build-ppl-windows]
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - name: Validate Linux container parity assets
        shell: bash
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/consumer/Tooling/container-parity"
          run_script="$root/runlabview-linux.sh"
          dev_script="$root/devmode-linux.sh"
          if [[ ! -f "$run_script" || ! -f "$dev_script" ]]; then
            echo "Missing required container parity scripts in consumer repo:" >&2
            echo "  expected: $run_script" >&2
            echo "  expected: $dev_script" >&2
            echo "Tip: ensure consumer_ref includes Tooling/container-parity assets." >&2
            ls -la "$GITHUB_WORKSPACE/consumer/Tooling" >&2 || true
            exit 127
          fi

      - name: Ensure NI Linux image availability
        shell: bash
        run: |
          set -euo pipefail
          if ! docker image inspect "$LINUX_LABVIEW_IMAGE" >/dev/null 2>&1; then
            if ! docker pull "$LINUX_LABVIEW_IMAGE"; then
              dockerfile_path="$GITHUB_WORKSPACE/docker/ni-lv-pwsh.Dockerfile"
              if [[ -f "$dockerfile_path" ]]; then
                echo "Preflight: pull failed; attempting local build from '$dockerfile_path'" >&2
                docker build -t "$LINUX_LABVIEW_IMAGE" -f "$dockerfile_path" "$GITHUB_WORKSPACE"
              else
                echo "Unable to pull Linux image and local Dockerfile not found: $LINUX_LABVIEW_IMAGE" >&2
                exit 1
              fi
            fi
          fi

      - name: Build Linux PPL in NI Linux container
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $linuxPplOutputRelativePath = $env:LINUX_PPL_OUTPUT_PATH
          if ($linuxPplOutputRelativePath.StartsWith('consumer/')) {
            $linuxPplOutputRelativePath = $linuxPplOutputRelativePath.Substring('consumer/'.Length)
          }
          $linuxPplOutputRelativePath = $linuxPplOutputRelativePath -replace '\\', '/'

          $consumerWorkspace = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $linuxContainerParityCommand = @'
          set -euo pipefail
          script_dir=/workspace/Tooling/container-parity
          run_script="$script_dir/runlabview-linux.sh"
          dev_script="$script_dir/devmode-linux.sh"
          if [[ ! -f "$run_script" || ! -f "$dev_script" ]]; then
            echo "Missing required container parity scripts in consumer repo:" >&2
            echo "  expected: $run_script" >&2
            echo "  expected: $dev_script" >&2
            echo "Tip: ensure consumer_ref includes Tooling/container-parity assets." >&2
            ls -la /workspace/Tooling >&2 || true
            exit 127
          fi
          tmp_script_dir="$(mktemp -d)"
          cleanup() { rm -rf "$tmp_script_dir"; }
          trap cleanup EXIT
          cp -a "$script_dir/." "$tmp_script_dir/"
          while IFS= read -r -d '' script_file; do
            sed -i 's/\r$//' "$script_file"
          done < <(find "$tmp_script_dir" -type f -name '*.sh' -print0)
          chmod +x "$tmp_script_dir/runlabview-linux.sh" "$tmp_script_dir/devmode-linux.sh"
          "$tmp_script_dir/runlabview-linux.sh"
          '@

          docker run --rm `
            -v "${consumerWorkspace}:/workspace" `
            -w /workspace `
            -e "LVIE_REPO_ROOT=/workspace" `
            -e "WORKSPACE_ROOT=/workspace" `
            -e "REPO_ROOT=/workspace" `
            -e "LVIE_PROJECT_RELATIVE_PATH=lv_icon_editor.lvproj" `
            -e "PROJECT_PATH_REL=lv_icon_editor.lvproj" `
            -e "LVIE_PROJECT_PATH=/workspace/lv_icon_editor.lvproj" `
            -e "PROJECT_PATH=/workspace/lv_icon_editor.lvproj" `
            -e "TARGET_DIR_REL=Test/Templates" `
            -e "CONTAINER_PARITY_EXCLUDE_FILES=Polymorphic Template.vi" `
            -e "CONTAINER_PARITY_BUILD_SPEC=true" `
            -e "CONTAINER_PARITY_BUILD_SPEC_NAME=Editor Packed Library" `
            -e "CONTAINER_PARITY_TARGET_NAME=My Computer" `
            -e "CONTAINER_PARITY_BUILD_OUTPUT_RELATIVE_PATH=$linuxPplOutputRelativePath" `
            -e "CONTAINER_PARITY_LABVIEW_VERSION=$env:LABVIEW_VERSION" `
            -e "LABVIEW_COMMUNITY_EDITION=true" `
            "$env:LINUX_LABVIEW_IMAGE" `
            bash -lc $linuxContainerParityCommand

          if ($LASTEXITCODE -ne 0) {
            throw "Linux PPL build command failed with exit code $LASTEXITCODE"
          }

      - name: Create Linux PPL bundle manifest
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pplPath = Join-Path $env:GITHUB_WORKSPACE $env:LINUX_PPL_OUTPUT_PATH
          if (-not (Test-Path -LiteralPath $pplPath -PathType Leaf)) {
            throw "Linux PPL output not found at '$pplPath'."
          }

          $bundleDir = Join-Path $env:RUNNER_TEMP 'ppl-bundle-linux'
          if (Test-Path -LiteralPath $bundleDir) {
            Remove-Item -LiteralPath $bundleDir -Recurse -Force
          }
          New-Item -Path $bundleDir -ItemType Directory -Force | Out-Null

          & "$env:GITHUB_WORKSPACE/scripts/New-PplBundleManifest.ps1" `
            -PplPath $pplPath `
            -OutputDirectory $bundleDir `
            -LabVIEWVersion $env:LABVIEW_VERSION `
            -Bitness $env:BITNESS `
            -WindowsImage $env:LINUX_LABVIEW_IMAGE `
            -BuildRunId "$env:GITHUB_RUN_ID" `
            -BuildRunAttempt "$env:GITHUB_RUN_ATTEMPT"

      - name: Upload Linux PPL bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-ppl-bundle-linux-${{ github.run_id }}
          path: ${{ runner.temp }}/ppl-bundle-linux
          if-no-files-found: error
