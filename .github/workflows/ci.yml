name: CI Pipeline

on:
  pull_request:
    paths:
      - 'tests/**'
      - 'schemas/**'
      - 'scripts/**'
      - 'vipm-cli-machine/**'
      - 'docker/**'
      - 'docs/**'
      - 'manifest.json'
      - 'README.md'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

permissions:
  contents: read

env:
  CONSUMER_REPO: svelderrainruiz/labview-icon-editor
  CONSUMER_REF: patch/456-2020-migration-branch-from-9e46ecf
  CONSUMER_EXPECTED_SHA: 9e46ecf591bc36afca8ddf4ce688a5f58604a12a
  WINDOWS_LABVIEW_IMAGE: nationalinstruments/labview:2026q1-windows
  LINUX_LABVIEW_IMAGE: nationalinstruments/labview:2026q1-linux-pwsh
  WINDOWS_PPL_OUTPUT_PATH: consumer/resource/plugins/lv_icon.windows.lvlibp
  LINUX_PPL_OUTPUT_PATH: consumer/resource/plugins/lv_icon.linux.lvlibp
  VIPB_PROJECT_PATH: 'consumer/Tooling/deployment/NI Icon editor.vipb'
  LABVIEW_VERSION: '2026'
  BITNESS: '64'

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run contract tests in Docker
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/Invoke-DockerContractCI.ps1 `
            -DockerImage 'mcr.microsoft.com/powershell:7.4-ubuntu-22.04' `
            -TestPath './tests/*.Tests.ps1'

      - name: Build NI image with PowerShell and pinned Pester
        shell: bash
        run: |
          set -euo pipefail
          docker build -t "$LINUX_LABVIEW_IMAGE" -f docker/ni-lv-pwsh.Dockerfile .

      - name: Run VIPM activation contract tests on NI image
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/Invoke-DockerContractCI.ps1 `
            -DockerImage $env:LINUX_LABVIEW_IMAGE `
            -TestPath './tests/VipmCliActivationContract.Tests.ps1'

  build-ppl-windows:
    runs-on: windows-latest
    needs: [contract-tests]
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - name: Validate Windows container parity assets
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $required = Join-Path $env:GITHUB_WORKSPACE 'consumer/Tooling/container-parity/runlabview-windows.ps1'
          if (-not (Test-Path -LiteralPath $required -PathType Leaf)) {
            throw "Missing required consumer script '$required'."
          }

      - name: Build Windows PPL in NI Windows container
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $windowsPplTargetRelativePath = $env:WINDOWS_PPL_OUTPUT_PATH
          if ($windowsPplTargetRelativePath.StartsWith('consumer/')) {
            $windowsPplTargetRelativePath = $windowsPplTargetRelativePath.Substring('consumer/'.Length)
          }
          $windowsPplTargetRelativePath = $windowsPplTargetRelativePath -replace '/', '\'
          $windowsPplBuildRelativePath = 'resource\plugins\lv_icon.lvlibp'

          docker image inspect "$env:WINDOWS_LABVIEW_IMAGE" *> $null
          if ($LASTEXITCODE -ne 0) {
            docker pull "$env:WINDOWS_LABVIEW_IMAGE"
          }
          if ($LASTEXITCODE -ne 0) {
            throw "Unable to pull/access Windows LabVIEW image '$env:WINDOWS_LABVIEW_IMAGE'. Ensure the image exists and runner authentication is configured."
          }

          $consumerWorkspace = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          docker run --rm `
            -v "${consumerWorkspace}:C:\workspace" `
            -e LVIE_REPO_ROOT=C:\workspace `
            -e WORKSPACE_ROOT=C:\workspace `
            -e REPO_ROOT=C:\workspace `
            -e "LVIE_PROJECT_RELATIVE_PATH=lv_icon_editor.lvproj" `
            -e "PROJECT_PATH_REL=lv_icon_editor.lvproj" `
            -e "LVIE_PROJECT_PATH=C:\workspace\lv_icon_editor.lvproj" `
            -e "PROJECT_PATH=C:\workspace\lv_icon_editor.lvproj" `
            -e "TARGET_DIR_REL=Test\Templates" `
            -e "CONTAINER_PARITY_EXCLUDE_FILES=Polymorphic Template.vi" `
            -e "CONTAINER_PARITY_BUILD_SPEC=true" `
            -e "CONTAINER_PARITY_BUILD_SPEC_NAME=Editor Packed Library" `
            -e "CONTAINER_PARITY_TARGET_NAME=My Computer" `
            -e "CONTAINER_PARITY_BUILD_OUTPUT_RELATIVE_PATH=$windowsPplBuildRelativePath" `
            -e "CONTAINER_PARITY_LABVIEW_VERSION=$env:LABVIEW_VERSION" `
            "$env:WINDOWS_LABVIEW_IMAGE" `
            powershell -NoProfile -ExecutionPolicy Bypass -File C:\workspace\Tooling\container-parity\runlabview-windows.ps1

          if ($LASTEXITCODE -ne 0) {
            throw "Windows PPL build command failed with exit code $LASTEXITCODE"
          }

          $builtPplPath = Join-Path $consumerWorkspace ($windowsPplBuildRelativePath -replace '\\', '/')
          if (-not (Test-Path -LiteralPath $builtPplPath -PathType Leaf)) {
            throw "Windows build output not found at '$builtPplPath'."
          }

          $targetPplPath = Join-Path $consumerWorkspace ($windowsPplTargetRelativePath -replace '\\', '/')
          if (-not ($builtPplPath.Equals($targetPplPath, [System.StringComparison]::OrdinalIgnoreCase))) {
            $targetDirectory = Split-Path -Path $targetPplPath -Parent
            if (-not [string]::IsNullOrWhiteSpace($targetDirectory) -and -not (Test-Path -LiteralPath $targetDirectory -PathType Container)) {
              New-Item -Path $targetDirectory -ItemType Directory -Force | Out-Null
            }
            Copy-Item -LiteralPath $builtPplPath -Destination $targetPplPath -Force
            Write-Host "Copied Windows PPL build output to expected bundle path: $targetPplPath"
          }

      - name: Create Windows PPL bundle manifest
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pplPath = Join-Path $env:GITHUB_WORKSPACE $env:WINDOWS_PPL_OUTPUT_PATH
          if (-not (Test-Path -LiteralPath $pplPath -PathType Leaf)) {
            throw "Windows PPL output not found at '$pplPath'."
          }

          $bundleDir = Join-Path $env:RUNNER_TEMP 'ppl-bundle-windows'
          if (Test-Path -LiteralPath $bundleDir) {
            Remove-Item -LiteralPath $bundleDir -Recurse -Force
          }
          New-Item -Path $bundleDir -ItemType Directory -Force | Out-Null

          & "$env:GITHUB_WORKSPACE/scripts/New-PplBundleManifest.ps1" `
            -PplPath $pplPath `
            -OutputDirectory $bundleDir `
            -LabVIEWVersion $env:LABVIEW_VERSION `
            -Bitness $env:BITNESS `
            -WindowsImage $env:WINDOWS_LABVIEW_IMAGE `
            -BuildRunId "$env:GITHUB_RUN_ID" `
            -BuildRunAttempt "$env:GITHUB_RUN_ATTEMPT"

      - name: Upload Windows raw PPL artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-ppl-windows-raw-${{ github.run_id }}
          path: ${{ github.workspace }}/${{ env.WINDOWS_PPL_OUTPUT_PATH }}
          if-no-files-found: error

      - name: Upload Windows PPL bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-ppl-bundle-windows-${{ github.run_id }}
          path: ${{ runner.temp }}/ppl-bundle-windows
          if-no-files-found: error

  build-ppl-linux:
    runs-on: ubuntu-latest
    needs: [contract-tests, build-ppl-windows]
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - name: Validate Linux container parity assets
        shell: bash
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/consumer/Tooling/container-parity"
          run_script="$root/runlabview-linux.sh"
          dev_script="$root/devmode-linux.sh"
          if [[ ! -f "$run_script" || ! -f "$dev_script" ]]; then
            echo "Missing required container parity scripts in consumer repo:" >&2
            echo "  expected: $run_script" >&2
            echo "  expected: $dev_script" >&2
            echo "Tip: ensure consumer_ref includes Tooling/container-parity assets." >&2
            ls -la "$GITHUB_WORKSPACE/consumer/Tooling" >&2 || true
            exit 127
          fi

      - name: Ensure NI Linux image availability
        shell: bash
        run: |
          set -euo pipefail
          if ! docker image inspect "$LINUX_LABVIEW_IMAGE" >/dev/null 2>&1; then
            if ! docker pull "$LINUX_LABVIEW_IMAGE"; then
              dockerfile_path="$GITHUB_WORKSPACE/docker/ni-lv-pwsh.Dockerfile"
              if [[ -f "$dockerfile_path" ]]; then
                echo "Preflight: pull failed; attempting local build from '$dockerfile_path'" >&2
                docker build -t "$LINUX_LABVIEW_IMAGE" -f "$dockerfile_path" "$GITHUB_WORKSPACE"
              else
                echo "Unable to pull Linux image and local Dockerfile not found: $LINUX_LABVIEW_IMAGE" >&2
                exit 1
              fi
            fi
          fi

      - name: Build Linux PPL in NI Linux container
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $linuxPplTargetRelativePath = $env:LINUX_PPL_OUTPUT_PATH
          if ($linuxPplTargetRelativePath.StartsWith('consumer/')) {
            $linuxPplTargetRelativePath = $linuxPplTargetRelativePath.Substring('consumer/'.Length)
          }
          $linuxPplTargetRelativePath = $linuxPplTargetRelativePath -replace '\\', '/'
          $linuxPplBuildRelativePath = 'resource/plugins/lv_icon.lvlibp'

          $consumerWorkspace = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $linuxContainerParityCommand = @'
          set -euo pipefail
          script_dir=/workspace/Tooling/container-parity
          run_script="$script_dir/runlabview-linux.sh"
          dev_script="$script_dir/devmode-linux.sh"
          if [[ ! -f "$run_script" || ! -f "$dev_script" ]]; then
            echo "Missing required container parity scripts in consumer repo:" >&2
            echo "  expected: $run_script" >&2
            echo "  expected: $dev_script" >&2
            echo "Tip: ensure consumer_ref includes Tooling/container-parity assets." >&2
            ls -la /workspace/Tooling >&2 || true
            exit 127
          fi
          tmp_script_dir="$(mktemp -d)"
          cleanup() { rm -rf "$tmp_script_dir"; }
          trap cleanup EXIT
          cp -a "$script_dir/." "$tmp_script_dir/"
          while IFS= read -r -d '' script_file; do
            sed -i 's/\r$//' "$script_file"
          done < <(find "$tmp_script_dir" -type f -name '*.sh' -print0)
          chmod +x "$tmp_script_dir/runlabview-linux.sh" "$tmp_script_dir/devmode-linux.sh"
          "$tmp_script_dir/runlabview-linux.sh"
          '@

          docker run --rm `
            -v "${consumerWorkspace}:/workspace" `
            -w /workspace `
            -e "LVIE_REPO_ROOT=/workspace" `
            -e "WORKSPACE_ROOT=/workspace" `
            -e "REPO_ROOT=/workspace" `
            -e "LVIE_PROJECT_RELATIVE_PATH=lv_icon_editor.lvproj" `
            -e "PROJECT_PATH_REL=lv_icon_editor.lvproj" `
            -e "LVIE_PROJECT_PATH=/workspace/lv_icon_editor.lvproj" `
            -e "PROJECT_PATH=/workspace/lv_icon_editor.lvproj" `
            -e "TARGET_DIR_REL=Test/Templates" `
            -e "CONTAINER_PARITY_EXCLUDE_FILES=Polymorphic Template.vi" `
            -e "CONTAINER_PARITY_BUILD_SPEC=true" `
            -e "CONTAINER_PARITY_BUILD_SPEC_NAME=Editor Packed Library" `
            -e "CONTAINER_PARITY_TARGET_NAME=My Computer" `
            -e "CONTAINER_PARITY_BUILD_OUTPUT_RELATIVE_PATH=$linuxPplBuildRelativePath" `
            -e "CONTAINER_PARITY_LABVIEW_VERSION=$env:LABVIEW_VERSION" `
            -e "LABVIEW_COMMUNITY_EDITION=true" `
            "$env:LINUX_LABVIEW_IMAGE" `
            bash -lc $linuxContainerParityCommand

          if ($LASTEXITCODE -ne 0) {
            throw "Linux PPL build command failed with exit code $LASTEXITCODE"
          }

          $builtPplPath = Join-Path $consumerWorkspace $linuxPplBuildRelativePath
          if (-not (Test-Path -LiteralPath $builtPplPath -PathType Leaf)) {
            throw "Linux build output not found at '$builtPplPath'."
          }

          $targetPplPath = Join-Path $consumerWorkspace $linuxPplTargetRelativePath
          if (-not ($builtPplPath.Equals($targetPplPath, [System.StringComparison]::OrdinalIgnoreCase))) {
            $targetDirectory = Split-Path -Path $targetPplPath -Parent
            if (-not [string]::IsNullOrWhiteSpace($targetDirectory) -and -not (Test-Path -LiteralPath $targetDirectory -PathType Container)) {
              New-Item -Path $targetDirectory -ItemType Directory -Force | Out-Null
            }
            Copy-Item -LiteralPath $builtPplPath -Destination $targetPplPath -Force
            Write-Host "Copied Linux PPL build output to expected bundle path: $targetPplPath"
          }

      - name: Create Linux PPL bundle manifest
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pplPath = Join-Path $env:GITHUB_WORKSPACE $env:LINUX_PPL_OUTPUT_PATH
          if (-not (Test-Path -LiteralPath $pplPath -PathType Leaf)) {
            throw "Linux PPL output not found at '$pplPath'."
          }

          $bundleDir = Join-Path $env:RUNNER_TEMP 'ppl-bundle-linux'
          if (Test-Path -LiteralPath $bundleDir) {
            Remove-Item -LiteralPath $bundleDir -Recurse -Force
          }
          New-Item -Path $bundleDir -ItemType Directory -Force | Out-Null

          & "$env:GITHUB_WORKSPACE/scripts/New-PplBundleManifest.ps1" `
            -PplPath $pplPath `
            -OutputDirectory $bundleDir `
            -LabVIEWVersion $env:LABVIEW_VERSION `
            -Bitness $env:BITNESS `
            -WindowsImage $env:LINUX_LABVIEW_IMAGE `
            -BuildRunId "$env:GITHUB_RUN_ID" `
            -BuildRunAttempt "$env:GITHUB_RUN_ATTEMPT"

      - name: Upload Linux raw PPL artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-ppl-linux-raw-${{ github.run_id }}
          path: ${{ github.workspace }}/${{ env.LINUX_PPL_OUTPUT_PATH }}
          if-no-files-found: error

      - name: Upload Linux PPL bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-ppl-bundle-linux-${{ github.run_id }}
          path: ${{ runner.temp }}/ppl-bundle-linux
          if-no-files-found: error

  gather-release-notes:
    runs-on: ubuntu-latest
    needs: [contract-tests]
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - name: Gather release notes artifact content
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $releaseNotesBundleDir = Join-Path $env:RUNNER_TEMP 'release-notes-prepared'
          if (Test-Path -LiteralPath $releaseNotesBundleDir) {
            Remove-Item -LiteralPath $releaseNotesBundleDir -Recurse -Force
          }
          New-Item -Path $releaseNotesBundleDir -ItemType Directory -Force | Out-Null

          $releaseNotesPath = Join-Path $env:GITHUB_WORKSPACE 'consumer/Tooling/deployment/release_notes.md'
          if (-not (Test-Path -LiteralPath $releaseNotesPath -PathType Leaf)) {
            New-Item -Path $releaseNotesPath -ItemType File -Force | Out-Null
          }
          $bundleReleaseNotesPath = Join-Path $releaseNotesBundleDir 'release_notes.md'
          Copy-Item -LiteralPath $releaseNotesPath -Destination $bundleReleaseNotesPath -Force

          $item = Get-Item -LiteralPath $bundleReleaseNotesPath
          $sha = (Get-FileHash -LiteralPath $bundleReleaseNotesPath -Algorithm SHA256).Hash.ToLowerInvariant()
          [pscustomobject]@{
            generated_utc = (Get-Date).ToUniversalTime().ToString('o')
            source_sha = $env:GITHUB_SHA
            source_repository = $env:GITHUB_REPOSITORY
            file_name = 'release_notes.md'
            sha256 = $sha
            size_bytes = [int64]$item.Length
          } | ConvertTo-Json -Depth 6 | Set-Content -LiteralPath (Join-Path $releaseNotesBundleDir 'release-notes-manifest.json') -Encoding UTF8

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-release-notes-${{ github.run_id }}
          path: ${{ runner.temp }}/release-notes-prepared
          if-no-files-found: error

  prepare-vipb-linux:
    runs-on: ubuntu-latest
    needs: [contract-tests, gather-release-notes]
    env:
      VERSION_MAJOR: '0'
      VERSION_MINOR: '1'
      VERSION_PATCH: '0'
      VERSION_BUILD: '${{ github.run_number }}'
      VERSION_COMMIT: '${{ github.sha }}'
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - id: labview-version
        name: Resolve LabVIEW version from consumer repo
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $versionHelper = Join-Path $consumerRoot 'Tooling/support/LabVIEWVersion.ps1'
          . $versionHelper
          $lvInfo = Get-LabVIEWVersionInfo -RepoRoot $consumerRoot
          "year=$($lvInfo.Year)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "minor=$($lvInfo.MinorRevision)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host ("Resolved LabVIEW version from consumer .lvversion: {0}" -f $lvInfo.Raw)

      - name: Download release notes artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-contract-release-notes-${{ github.run_id }}
          path: ${{ runner.temp }}/release-notes-prepared

      - name: Install gathered release notes for VIPB preparation
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $sourceReleaseNotesPath = Join-Path $env:RUNNER_TEMP 'release-notes-prepared/release_notes.md'
          if (-not (Test-Path -LiteralPath $sourceReleaseNotesPath -PathType Leaf)) {
            throw "Gathered release notes artifact is missing '$sourceReleaseNotesPath'."
          }
          $targetReleaseNotesPath = Join-Path $env:GITHUB_WORKSPACE 'consumer/Tooling/deployment/release_notes.md'
          Copy-Item -LiteralPath $sourceReleaseNotesPath -Destination $targetReleaseNotesPath -Force

      - id: display-info
        name: Generate VIP display information JSON
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $releaseNotesPath = Join-Path $consumerRoot 'Tooling/deployment/release_notes.md'
          $releaseNotes = if (Test-Path -LiteralPath $releaseNotesPath -PathType Leaf) {
            Get-Content -Raw -Path $releaseNotesPath
          } else {
            ''
          }

          $info = @{
            "Package Version" = @{
              "major" = [int]$env:VERSION_MAJOR
              "minor" = [int]$env:VERSION_MINOR
              "patch" = [int]$env:VERSION_PATCH
              "build" = [int]$env:VERSION_BUILD
            }
            "Product Name" = "labview-icon-editor"
            "Company Name" = "${{ github.repository_owner }}"
            "Author Name (Person or Company)" = "${{ github.repository }}"
            "Product Homepage (URL)" = "https://github.com/${{ github.repository }}"
            "Legal Copyright" = "Copyright $(Get-Date -Format yyyy) ${{ github.repository_owner }}"
            "Product Description Summary" = "labview-icon-editor VI Package build."
            "Product Description" = "labview-icon-editor VI Package build."
            "Release Notes - Change Log" = $releaseNotes
          }

          $json = $info | ConvertTo-Json -Depth 6 -Compress
          "json=$json" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - id: vipb_diag
        name: Run VIPB diagnostics suite
        continue-on-error: true
        shell: pwsh
        env:
          DISPLAY_INFORMATION_JSON: ${{ steps.display-info.outputs.json }}
        run: |
          $ErrorActionPreference = 'Stop'
          $bundleDir = Join-Path $env:RUNNER_TEMP 'vipb-prepared-linux'
          if (Test-Path -LiteralPath $bundleDir) {
            Remove-Item -LiteralPath $bundleDir -Recurse -Force
          }
          New-Item -Path $bundleDir -ItemType Directory -Force | Out-Null

          & "$env:GITHUB_WORKSPACE/scripts/Invoke-PrepareVipbDiagnostics.ps1" `
            -RepoRoot (Join-Path $env:GITHUB_WORKSPACE 'consumer') `
            -VipbPath (Join-Path $env:GITHUB_WORKSPACE $env:VIPB_PROJECT_PATH) `
            -ReleaseNotesFile (Join-Path $env:GITHUB_WORKSPACE 'consumer/Tooling/deployment/release_notes.md') `
            -DisplayInformationJson $env:DISPLAY_INFORMATION_JSON `
            -LabVIEWVersionYear '${{ steps.labview-version.outputs.year }}' `
            -LabVIEWMinorRevision '${{ steps.labview-version.outputs.minor }}' `
            -SupportedBitness '64' `
            -Major $env:VERSION_MAJOR `
            -Minor $env:VERSION_MINOR `
            -Patch $env:VERSION_PATCH `
            -Build $env:VERSION_BUILD `
            -Commit $env:VERSION_COMMIT `
            -OutputDirectory $bundleDir `
            -SourceRepository '${{ github.repository }}' `
            -SourceRef '${{ github.ref }}' `
            -SourceSha '${{ github.sha }}' `
            -BuildRunId '${{ github.run_id }}' `
            -BuildRunAttempt '${{ github.run_attempt }}' `
            -UpdateScriptPath (Join-Path $env:GITHUB_WORKSPACE 'scripts/Update-VipbDisplayInfo.ps1')

      - name: Publish VIPB diagnostics summary
        if: always()
        shell: pwsh
        run: |
          $summaryPath = Join-Path $env:RUNNER_TEMP 'vipb-prepared-linux/vipb-diagnostics-summary.md'
          if (Test-Path -LiteralPath $summaryPath -PathType Leaf) {
            Get-Content -LiteralPath $summaryPath -Raw | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            @(
              ''
              '- Artifact: `docker-contract-vipb-prepared-linux-${{ github.run_id }}`'
              '- Source: `runner.temp/vipb-prepared-linux`'
            ) -join [Environment]::NewLine | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          } else {
            @(
              '## VIPB Diagnostics Suite'
              ''
              '- Status: failed (diagnostics summary not generated)'
              '- Expected summary path: `' + $summaryPath + '`'
              '- Expected artifact: `docker-contract-vipb-prepared-linux-${{ github.run_id }}`'
              '- Source: `runner.temp/vipb-prepared-linux`'
            ) -join [Environment]::NewLine | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

      - name: Upload prepared VIPB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-vipb-prepared-linux-${{ github.run_id }}
          path: ${{ runner.temp }}/vipb-prepared-linux
          if-no-files-found: error

      - name: Fail if VIPB diagnostics suite failed
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $statusPath = Join-Path $env:RUNNER_TEMP 'vipb-prepared-linux/prepare-vipb.status.json'
          if (-not (Test-Path -LiteralPath $statusPath -PathType Leaf)) {
            throw "VIPB diagnostics status file missing: $statusPath"
          }

          $statusPayload = Get-Content -LiteralPath $statusPath -Raw | ConvertFrom-Json
          $status = [string]$statusPayload.status
          if ($status -eq 'failed') {
            $errorPath = Join-Path $env:RUNNER_TEMP 'vipb-prepared-linux/prepare-vipb.error.json'
            throw "VIPB diagnostics suite failed. See '$errorPath'."
          }

          if ('${{ steps.vipb_diag.outcome }}' -eq 'failure') {
            throw "VIPB diagnostics execution step failed despite non-failed status '$status'."
          }
          Write-Host "VIPB diagnostics suite completed with status '$status'."

  build-vip-self-hosted:
    runs-on: [self-hosted, windows, self-hosted-windows-lv]
    needs: [build-ppl-windows, build-ppl-linux, prepare-vipb-linux]
    env:
      VERSION_MAJOR: '0'
      VERSION_MINOR: '1'
      VERSION_PATCH: '0'
      VERSION_BUILD: '${{ github.run_number }}'
      VERSION_COMMIT: '${{ github.sha }}'
      VIPM_TIMEOUT_SECONDS: '900'
      LVIE_RUNNER_CLI_SKIP_BUILD: '1'
      LVIE_RUNNER_CLI_SKIP_DOWNLOAD: '1'
    steps:
      - name: Checkout skill repository
        uses: actions/checkout@v4

      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONSUMER_REPO }}
          ref: ${{ env.CONSUMER_REF }}
          path: consumer

      - name: Verify checked out consumer SHA
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $actualSha = (git -C consumer rev-parse HEAD).Trim()
          if ($actualSha -ne $env:CONSUMER_EXPECTED_SHA) {
            throw "Consumer SHA mismatch. Expected '$env:CONSUMER_EXPECTED_SHA', got '$actualSha'."
          }
          Write-Host "Consumer SHA verified: $actualSha"

      - name: Validate self-hosted native LabVIEW prerequisites
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $requiredFiles = @(
            'Tooling/Invoke-VipBuild.ps1',
            '.github/actions/build-lvlibp/BuildProjectSpec.ps1',
            '.github/actions/rename-file/Rename-file.ps1',
            'Tooling/support/LabVIEWVersion.ps1',
            'Tooling/deployment/NI Icon editor.vipb'
          )
          foreach ($relativePath in $requiredFiles) {
            $fullPath = Join-Path $consumerRoot $relativePath
            if (-not (Test-Path -LiteralPath $fullPath -PathType Leaf)) {
              throw "Missing required consumer asset '$fullPath'."
            }
          }
          if (-not (Get-Command g-cli -ErrorAction SilentlyContinue)) {
            throw "Required command 'g-cli' not found on PATH for self-hosted packaging lane."
          }

      - id: labview-version
        name: Resolve LabVIEW version from consumer repo
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $versionHelper = Join-Path $consumerRoot 'Tooling/support/LabVIEWVersion.ps1'
          . $versionHelper
          $lvInfo = Get-LabVIEWVersionInfo -RepoRoot $consumerRoot
          "year=$($lvInfo.Year)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "minor=$($lvInfo.MinorRevision)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host ("Resolved LabVIEW version from consumer .lvversion: {0}" -f $lvInfo.Raw)

      - name: Bootstrap worktree guard context
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $worktreeRoot = Join-Path $env:GITHUB_WORKSPACE 'worktrees'
          if (-not (Test-Path -LiteralPath $worktreeRoot -PathType Container)) {
            New-Item -Path $worktreeRoot -ItemType Directory -Force | Out-Null
          }
          "LVIE_WORKTREE_ROOT=$worktreeRoot" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "LVIE_SKIP_WORKTREE_ROOT_CHECK=1" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Exported LVIE_WORKTREE_ROOT=$worktreeRoot"

      - name: Ensure release notes file exists
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $releaseNotesPath = Join-Path $env:GITHUB_WORKSPACE 'consumer/Tooling/deployment/release_notes.md'
          if (-not (Test-Path -LiteralPath $releaseNotesPath -PathType Leaf)) {
            New-Item -Path $releaseNotesPath -ItemType File -Force | Out-Null
          }

      - name: Download Windows PPL bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-contract-ppl-bundle-windows-${{ github.run_id }}
          path: ${{ runner.temp }}/ppl-bundle-windows

      - name: Download prepared VIPB artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-contract-vipb-prepared-linux-${{ github.run_id }}
          path: ${{ runner.temp }}/vipb-prepared-linux

      - name: Consume prepared VIPB from Linux artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $sourceVipbPath = Join-Path $env:RUNNER_TEMP 'vipb-prepared-linux/NI Icon editor.vipb'
          if (-not (Test-Path -LiteralPath $sourceVipbPath -PathType Leaf)) {
            throw "Prepared VIPB artifact is missing '$sourceVipbPath'."
          }

          $targetVipbPath = Join-Path $env:GITHUB_WORKSPACE $env:VIPB_PROJECT_PATH
          $targetVipbDirectory = Split-Path -Path $targetVipbPath -Parent
          if (-not (Test-Path -LiteralPath $targetVipbDirectory -PathType Container)) {
            New-Item -Path $targetVipbDirectory -ItemType Directory -Force | Out-Null
          }
          Copy-Item -LiteralPath $sourceVipbPath -Destination $targetVipbPath -Force
          Write-Host "Using prepared VIPB from Linux artifact: $targetVipbPath"

      - name: Consume Windows-built x64 PPL bundle
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $bundleDir = Join-Path $env:RUNNER_TEMP 'ppl-bundle-windows'
          $targetPplPath = Join-Path $env:GITHUB_WORKSPACE 'consumer/resource/plugins/lv_icon_x64.lvlibp'
          & "$env:GITHUB_WORKSPACE/scripts/Invoke-PplBundleConsume.ps1" `
            -BundleDirectory $bundleDir `
            -OutputPplPath $targetPplPath `
            -ExpectedLabVIEWVersion $env:LABVIEW_VERSION `
            -ExpectedBitness '64'

      - name: Build native 32-bit PPL
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          & "$consumerRoot/.github/actions/build-lvlibp/BuildProjectSpec.ps1" `
            -LabVIEWVersion '${{ steps.labview-version.outputs.year }}' `
            -SupportedBitness 32 `
            -RepoRoot "$consumerRoot" `
            -Major $env:VERSION_MAJOR `
            -Minor $env:VERSION_MINOR `
            -Patch $env:VERSION_PATCH `
            -Build $env:VERSION_BUILD `
            -Commit $env:VERSION_COMMIT `
            -SkipWorktreeRootCheck
          & "$consumerRoot/.github/actions/rename-file/Rename-file.ps1" `
            -CurrentFilename "$consumerRoot/resource/plugins/lv_icon.lvlibp" `
            -NewFilename "$consumerRoot/resource/plugins/lv_icon_x86.lvlibp"

      - name: Validate consumed x64 and native x86 PPL outputs
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $x64Path = Join-Path $consumerRoot 'resource/plugins/lv_icon_x64.lvlibp'
          $x86Path = Join-Path $consumerRoot 'resource/plugins/lv_icon_x86.lvlibp'
          if (-not (Test-Path -LiteralPath $x64Path -PathType Leaf)) {
            throw "Consumed x64 PPL output not found at '$x64Path'."
          }
          if (-not (Test-Path -LiteralPath $x86Path -PathType Leaf)) {
            throw "Native x86 PPL output not found at '$x86Path'."
          }

      - id: display-info
        name: Generate VIP display information JSON
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $releaseNotesPath = Join-Path $consumerRoot 'Tooling/deployment/release_notes.md'
          $releaseNotes = if (Test-Path -LiteralPath $releaseNotesPath -PathType Leaf) {
            Get-Content -Raw -Path $releaseNotesPath
          } else {
            ''
          }

          $info = @{
            "Package Version" = @{
              "major" = [int]$env:VERSION_MAJOR
              "minor" = [int]$env:VERSION_MINOR
              "patch" = [int]$env:VERSION_PATCH
              "build" = [int]$env:VERSION_BUILD
            }
            "Product Name" = "labview-icon-editor"
            "Company Name" = "${{ github.repository_owner }}"
            "Author Name (Person or Company)" = "${{ github.repository }}"
            "Product Homepage (URL)" = "https://github.com/${{ github.repository }}"
            "Legal Copyright" = "Copyright $(Get-Date -Format yyyy) ${{ github.repository_owner }}"
            "Product Description Summary" = "labview-icon-editor VI Package build."
            "Product Description" = "labview-icon-editor VI Package build."
            "Release Notes - Change Log" = $releaseNotes
          }

          $json = $info | ConvertTo-Json -Depth 6 -Compress
          "json=$json" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload consumed VIPB (post-mortem)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-vipb-modified-self-hosted-${{ github.run_id }}
          path: ${{ env.VIPB_PROJECT_PATH }}
          if-no-files-found: warn

      - name: Build VI Package (LV 64-bit)
        shell: pwsh
        env:
          DISPLAY_INFORMATION_JSON: ${{ steps.display-info.outputs.json }}
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          & "$consumerRoot/Tooling/Invoke-VipBuild.ps1" `
            -SupportedBitness 64 `
            -RepoRoot "$consumerRoot" `
            -VIPBPath "Tooling/deployment/NI Icon editor.vipb" `
            -LabVIEWVersion '${{ steps.labview-version.outputs.year }}' `
            -LabVIEWMinorRevision '${{ steps.labview-version.outputs.minor }}' `
            -Major $env:VERSION_MAJOR `
            -Minor $env:VERSION_MINOR `
            -Patch $env:VERSION_PATCH `
            -Build $env:VERSION_BUILD `
            -Commit $env:VERSION_COMMIT `
            -ReleaseNotesFile "$consumerRoot/Tooling/deployment/release_notes.md" `
            -DisplayInformationJSON $env:DISPLAY_INFORMATION_JSON `
            -VipmTimeoutSeconds $env:VIPM_TIMEOUT_SECONDS

      - id: locate-vip
        name: Locate built VI package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $consumerRoot = Join-Path $env:GITHUB_WORKSPACE 'consumer'
          $vipCandidates = Get-ChildItem -Path $consumerRoot -Recurse -File -Filter '*.vip' |
            Sort-Object LastWriteTimeUtc -Descending

          if (-not $vipCandidates -or $vipCandidates.Count -eq 0) {
            throw "No .vip artifact found under '$consumerRoot' after self-hosted native package build."
          }

          $vipFile = $vipCandidates[0]
          "vip_file_path=$($vipFile.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "vip_file_name=$($vipFile.Name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload self-hosted VI Package artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-contract-vip-package-self-hosted-${{ github.run_id }}
          path: ${{ steps.locate-vip.outputs.vip_file_path }}
          if-no-files-found: error
